# ===========================================
# Docker Compose - Relay Client (Local/Internal)
# ===========================================
# Deploy this on your LOCAL/INTERNAL server
# This connects to the PUBLIC Redis server and forwards webhooks
#
# Usage:
#   docker compose up -d

services:
  # Relay Client - Consumes from Redis and forwards to internal services
  relay-client:
    image: ghcr.io/quantumsolver/webrelay-client:latest
    container_name: webrelay-client
    restart: unless-stopped
    ports:
      - "3003:3003"  # Health check endpoint
    environment:
      # Redis Configuration (connects to PUBLIC Redis)
      - REDIS_URL=${REDIS_URL}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DB=${REDIS_DB:-0}
      
      # Stream Configuration (must match server)
      - STREAM_NAME=${STREAM_NAME:-webhook-stream}
      - CONSUMER_GROUP=${CONSUMER_GROUP:-relay-group}
      - DEAD_LETTER_QUEUE=${DEAD_LETTER_QUEUE:-webhook-dlq}
      
      # Consumer Identity
      - CONSUMER_NAME=${CONSUMER_NAME:-webrelay-client-local}
      
      # Realtime Service (PUBLIC URL of your server)
      - REALTIME_URL=${REALTIME_URL}
      
      # Client Configuration
      - CLIENT_PORT=3003
      - WORKER_COUNT=${WORKER_COUNT:-5}
      - BATCH_SIZE=${BATCH_SIZE:-10}
      - BLOCK_TIMEOUT=${BLOCK_TIMEOUT:-5000}
    # Important: Use host network to access internal services
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
